rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Users collection ──────────────────────────────────────────────
    // Each document ID is the username. Only progress data is stored.
    // Without Firebase Auth we can't verify identity server-side,
    // but we restrict the shape of writes to prevent abuse.
    match /users/{userId} {
      // Anyone can read any user doc (needed to load progress on login).
      allow read: if true;

      // Only allow writes that contain expected fields and no extra data.
      // This prevents someone from injecting arbitrary data.
      allow write: if request.resource.data.keys().hasOnly(['progress', 'lastUpdated'])
                   && request.resource.data.progress is map;
    }

    // ── Reports collection ────────────────────────────────────────────
    match /reports/{reportId} {
      // Anyone can create a report, but only with the correct expected fields.
      allow create: if request.resource.data.keys().hasAll(['wordId', 'word', 'issue', 'reportedBy', 'timestamp', 'status'])
                    && request.resource.data.status == 'pending';

      // Anyone can read reports (needed for the admin panel client-side).
      allow read: if true;

      // Only allow updating the status field (for admin resolution).
      // The update must set status to 'resolved' and include resolvedBy + resolvedAt.
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'resolvedBy', 'resolvedAt'])
                    && request.resource.data.status == 'resolved';

      // Nobody can delete reports from the client.
      allow delete: if false;
    }

  }
}
